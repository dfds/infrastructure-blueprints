name: Generate blueprints for SSM Agent

on:
  repository_dispatch:
    types: [trigger-ssm-agent-workflow]
  workflow_dispatch:
jobs:
  generate-blueprint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Checkout terraform-aws-ssm-agent
        uses: actions/checkout@v4
        with:
          repository: dfds/terraform-aws-ssm-agent
          path: ./aws-ssm-agent/aws-modules-ssm-agent
          ref: ${{ github.event.client_payload.release_tag }}
          token: ${{ secrets.AUTH_TOKEN }}

      - name: Build docker image
        working-directory: ./tools
        run: |
          docker build -t scaffold:latest .
        shell: bash

      - name: Run script
        run: |
          input=$(pwd)/aws-ssm-agent/aws-modules-ssm-agent/
          templates=$(pwd)/tools/scaffolding/templates/aws-ssm-agent/
          output=$(pwd)/aws-ssm-agent/generic/
          if [ -d $output ]; then
              rm -rf $output
          fi
          mkdir -p $output

          docker run -e RELEASE=${{ github.event.client_payload.release_tag }} -e APP_NAME=ssm-agent -v $input:/module \
                        -v $templates/:/templates \
                        -v $output:/output scaffold:latest

          sudo chown -R $USER:$USER $output

        shell: bash

      - name: setup git config
        run: |
          # setup the username and email.
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      - name: Create a pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Github Actions update blueprints for SSM Agent module"
          title: "Github Actions update blueprints for SSM Agent module"
          body: |
            Updates generated by the GitHub Actions workflow.
          branch: blueprint-updates
          base: main
          labels: blueprints
